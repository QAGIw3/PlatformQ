# Digital Asset Service

## Purpose

The **Digital Asset Service** is the central registry and source of truth for all Digital Assets within the platformQ ecosystem. It provides a RESTful API for creating, reading, updating, and deleting asset metadata. This service also consumes events to update asset information based on external processing.

## Core Concepts

A **Digital Asset** is the platform's canonical representation of any piece of data, whether it's a 3D model, a business contact, a simulation log, or a document. This service stores the unified metadata for these assets, while the raw data is typically stored in a more appropriate location (like Nextcloud or an S3-compatible object store).

## Architecture

*   **Database**: This service is backed by a **PostgreSQL** database to robustly handle the relational nature of assets and their links. Database schema changes are managed by **Alembic** migrations located in the `migrations/` directory.
*   **API**: A FastAPI application provides a standard CRUD interface for managing assets.
*   **Event Consumption**: The service includes a background consumer that listens for and processes `FunctionExecutionCompleted` events from Pulsar.

## API Endpoints

The service exposes the following main endpoints under the `/api/v1` prefix:

*   **Digital Assets (`/api/v1/digital-assets`)**:
    *   `POST /digital-assets`: Creates a new digital asset.
    *   `GET /digital-assets`: Lists all digital assets with pagination.
    *   `GET /digital-assets/{asset_id}`: Retrieves a specific asset.
    *   `PATCH /digital-assets/{asset_id}`: Updates an asset's properties.
    *   `DELETE /digital-assets/{asset_id}`: Deletes an asset.

*   **Processing Rules (`/api/v1/processing-rules`)**:
    *   (Details to be added based on `app/api/endpoints/processing_rules.py`)

For detailed API specifications, please refer to the OpenAPI documentation generated by the service.

## Event-Driven Architecture

### Events Consumed

-   **Topic Pattern**: `persistent://platformq/.*/function-execution-completed-events`
-   **Schema**: `FunctionExecutionCompleted`
-   **Description**: This event is consumed to update the metadata of digital assets after a function (e.g., a WASM module) has completed its execution on the asset. If the status is "SUCCESS" and `results` are present, the asset's metadata in the database is updated. If the status is "FAILURE", an error is logged.

## How to Run Locally

1.  **Install Requirements**:
    Navigate to the `services/digital-asset-service` directory and install the Python dependencies:
    ```bash
    pip install -r requirements.txt
    ```

2.  **Set Environment Variables**:
    Ensure your environment is configured with PostgreSQL connection details (e.g., `DATABASE_URL`) and Pulsar URL (`PULSAR_URL`). In a production setup, these would be managed by Consul/Vault.

3.  **Run Alembic Migrations**:
    Before running the service for the first time, ensure your PostgreSQL database is set up and then apply the Alembic migrations:
    ```bash
    alembic upgrade head
    ```

4.  **Run the Service**:
    Start the FastAPI application using Uvicorn from the `services/digital-asset-service` directory:
    ```bash
    uvicorn app.main:app --host 0.0.0.0 --port 8000
    ```
    The Pulsar consumer will start in a background thread upon application startup.

## Dependencies

-   `FastAPI`: Web framework for building the API.
-   `SQLAlchemy`: ORM for database interactions.
-   `psycopg2-binary` (or `asyncpg`): PostgreSQL database adapter.
-   `Alembic`: Database migration tool.
-   `apache-pulsar`: Client library for interacting with Pulsar.
-   `platformq_shared.base_service`: Shared library for common service functionalities.
-   `platformq_shared.config`: Shared library for loading configuration.
-   `platformq_shared.events`: Defines the event schemas (e.g., `FunctionExecutionCompleted`) consumed by the service. 